#!/usr/bin/env node

const { Client } = require('pg');
const request = require('request-promise');
const client = new Client({
  connectionString: process.env.DATABASE_URL
});

const API_URL = 'http://api-editoriales.clarin.com/api/mobile/transito/subtes/';
const currentStatus = request({
  uri: API_URL,
  json: true
}).then(function(response) {
  return response.items.reduce(function(acc, line) {
    acc[line.ubicacion_nombre_corto] = line.estado;
  }, {})
});

(async function() {
  await client.connect();

  const res = client.query('SELECT * FROM subways');

  await res;
  await currentStatus;

  const procs = [];

  res.rows.forEach(function(row) {
    if (!row.line) return;

    const line = String.fromCharCode(row.line);
    const status = row.status;

    if (line in status && row.status !== currentStatus[line]) {
      console.log(`cambi√≥ el estado de la linea ${line} de ${row.status} a ${currentStatus[line]}`);
      procs.push(client.query('UPDATE subways SET status = $1 WHERE line = $2', [currentStatus[line], line]));
    }
  })


  console.log(res.rows);
  console.log(currentStatus);

  for (let proc of procs) {
    await proc;
  }

  await client.end();
})()
